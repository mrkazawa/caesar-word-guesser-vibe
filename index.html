<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Caesar Word Guesser</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .game-header {
        color: #0d1a4a;
        font-family: "Segoe UI", "Arial", sans-serif;
        font-weight: bold;
        letter-spacing: 1px;
      }
      /* Rank colors for leaderboard */
      .rank-gold {
        color: #8d6a00 !important;
        font-weight: bold;
      }
      .rank-silver {
        color: #444444 !important;
        font-weight: bold;
      }
      .rank-copper {
        color: #5a2e0c !important;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div
      class="container min-vh-100 d-flex justify-content-center align-items-center"
    >
      <div class="w-100">
        <div id="gameContainer"></div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Leaderboard helpers
      function getLeaderboard() {
        return JSON.parse(localStorage.getItem("leaderboard") || "[]");
      }
      function saveLeaderboard(entry) {
        const leaderboard = getLeaderboard();
        leaderboard.push(entry);
        localStorage.setItem("leaderboard", JSON.stringify(leaderboard));
      }
      function leaderboardTableHtml() {
        const leaderboard = getLeaderboard()
          .sort((a, b) => b.score - a.score)
          .slice(0, 10); // Only show top 10
        let html = `
<table class="table table-sm table-bordered text-center mb-4">
  <thead class="table-primary">
    <tr>
      <th>Rank</th>
      <th>Username</th>
      <th>School</th>
      <th>Score</th>
    </tr>
  </thead>
  <tbody>
`;
        for (let i = 0; i < 10; i++) {
          const entry = leaderboard[i];
          let rankDisplay = "-";
          let rankClass = "";
          if (i === 0) {
            rankDisplay = "ðŸ¥‡";
            rankClass = "rank-gold";
          } else if (i === 1) {
            rankDisplay = "ðŸ¥ˆ";
            rankClass = "rank-silver";
          } else if (i === 2) {
            rankDisplay = "ðŸ¥‰";
            rankClass = "rank-copper";
          } else if (entry) {
            rankDisplay = String(i + 1);
          }
          html += `
    <tr>
      <td class="${rankClass}">${rankDisplay}</td>
      <td class="${rankClass}">${entry ? entry.username : "-"}</td>
      <td class="${rankClass}">${entry ? entry.school : "-"}</td>
      <td class="${rankClass}">${entry ? entry.score : "-"}</td>
    </tr>
`;
        }
        html += `
  </tbody>
</table>
`;
        return html;
      }
      // Load caesarCipher.js
      let caesarCipher;
      let encrypt;
      let decrypt;
      // Load questions.json
      let questions = [];
      let selectedWord = "";
      let encryptedWord = "";
      let key = 0;
      // Move startTime and timerInterval to global scope
      let startTime;
      let timerInterval;

      // Fetch questions.json
      fetch("questions.json")
        .then((response) => response.json())
        .then((data) => {
          questions = data;
        });

      // Caesar cipher implementation (copied from caesarCipher.js)
      caesarCipher = function (text, key) {
        return text
          .split("")
          .map((char) => {
            if (char.match(/[a-z]/)) {
              let code = char.charCodeAt(0);
              return String.fromCharCode(((code - 97 + key + 26) % 26) + 97);
            } else if (char.match(/[A-Z]/)) {
              let code = char.charCodeAt(0);
              return String.fromCharCode(((code - 65 + key + 26) % 26) + 65);
            } else {
              return char;
            }
          })
          .join("");
      };
      encrypt = function (text, key) {
        return caesarCipher(text, key);
      };
      decrypt = function (text, key) {
        return caesarCipher(text, -key);
      };

      // Render home screen
      function renderHome() {
        document.getElementById("gameContainer").innerHTML = `
          <div class="row justify-content-center">
            <div class="col-md-5 col-12 mb-4 mb-md-0 pe-md-5 pe-4">
              <h2 class="game-header text-center mb-4">Guess The Word</h2>
              <form id="startForm">
                <div class="mb-3">
                  <label for="username" class="form-label">Username</label>
                  <input type="text" class="form-control" id="username" name="username" required />
                </div>
                <div class="mb-3">
                  <label for="school" class="form-label">School</label>
                  <input type="text" class="form-control" id="school" name="school" required />
                </div>
                <button type="submit" class="btn btn-primary w-100">Play</button>
              </form>
            </div>
            <div class="col-md-7 col-12 ps-md-5 ps-4">
              <div class="d-flex align-items-center justify-content-between mb-4">
                <h2 class="game-header text-center mb-0">Leaderboard</h2>
                <button id="clearLeaderboardBtn" class="btn btn-danger ms-3">Clear Table</button>
              </div>
              <div id="leaderboardContainer">
                ${leaderboardTableHtml()}
              </div>
            </div>
          </div>
          <!-- Modal for password input -->
          <div class="modal fade" id="clearModal" tabindex="-1" aria-labelledby="clearModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="clearModalLabel">Clear Leaderboard</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="mb-3">
                    <label for="clearPassword" class="form-label">Enter password to clear:</label>
                    <input type="password" class="form-control" id="clearPassword" autocomplete="off" />
                  </div>
                  <div id="clearError" class="text-danger small" style="display:none;">Incorrect password.</div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="button" class="btn btn-primary" id="confirmClearBtn">Submit</button>
                </div>
              </div>
            </div>
          </div>
        `;
        document
          .getElementById("startForm")
          .addEventListener("submit", startGame);
        // Add clear leaderboard button handler
        const clearBtn = document.getElementById("clearLeaderboardBtn");
        if (clearBtn) {
          clearBtn.onclick = function () {
            const clearModal = new bootstrap.Modal(
              document.getElementById("clearModal")
            );
            document.getElementById("clearPassword").value = "";
            document.getElementById("clearError").style.display = "none";
            clearModal.show();
            document.getElementById("confirmClearBtn").onclick = function () {
              const pwd = document.getElementById("clearPassword").value;
              if (pwd === "isbmantap") {
                localStorage.removeItem("leaderboard");
                document.getElementById("leaderboardContainer").innerHTML =
                  leaderboardTableHtml();
                clearModal.hide();
                // Re-attach handler after re-render
                const newClearBtn = document.getElementById(
                  "clearLeaderboardBtn"
                );
                if (newClearBtn) {
                  newClearBtn.onclick = clearBtn.onclick;
                }
              } else {
                document.getElementById("clearError").style.display = "block";
              }
            };
          };
        }
      }

      // Render question screen
      function renderQuestion() {
        // Select a random word
        if (questions.length === 0) {
          alert("Questions not loaded yet. Please try again.");
          return;
        }
        // Get username from previous form
        const username = document.getElementById("username").value;
        // Start timer
        startTime = Date.now();
        let timerInterval;
        function formatTime(ms) {
          const totalSeconds = Math.floor(ms / 1000);
          const minutes = String(Math.floor(totalSeconds / 60)).padStart(
            2,
            "0"
          );
          const seconds = String(totalSeconds % 60).padStart(2, "0");
          return `${minutes}:${seconds}`;
        }
        // Select word and encrypt
        const randomIndex = Math.floor(Math.random() * questions.length);
        selectedWord = questions[randomIndex].word;
        key = Math.floor(Math.random() * 25) + 1; // key between 1 and 25
        encryptedWord = encrypt(selectedWord, key).toUpperCase();

        function buildAlphabetTable(key) {
          const real = Array.from({ length: 26 }, (_, i) =>
            String.fromCharCode(65 + i)
          );
          const shifted = real.map((c, i) =>
            String.fromCharCode(65 + ((i + key) % 26))
          );
          const usedReal = Array.from(
            new Set(selectedWord.toUpperCase().split(""))
          );
          const usedShifted = Array.from(new Set(encryptedWord.split("")));
          let blankReal = new Set();
          let blankShifted = new Set();
          usedReal.forEach((letter) => {
            let idx = real.indexOf(letter);
            if (idx !== -1) {
              if (Math.random() < 0.5) {
                blankReal.add(letter);
              } else {
                blankShifted.add(shifted[idx]);
              }
            }
          });
          let rows = [];
          for (let i = 0; i < 26; i += 13) {
            rows.push({
              real: real
                .slice(i, i + 13)
                .map((c) => (blankReal.has(c) ? "" : c)),
              shifted: shifted
                .slice(i, i + 13)
                .map((c) => (blankShifted.has(c) ? "" : c)),
            });
          }
          let html = `<table class='table table-bordered text-center align-middle mt-3'>
            <thead>
              <tr><th colspan='13'>Alphabet Mapping (Key: ${key})</th></tr>
            </thead>
            <tbody>`;
          rows.forEach((row) => {
            html +=
              `<tr>` +
              row.real
                .map(
                  (c) =>
                    `<th style='background-color:#e3f2fd;color:#1565c0;'>${
                      c || "&nbsp;"
                    }</th>`
                )
                .join("") +
              `</tr>`;
            html +=
              `<tr>` +
              row.shifted
                .map(
                  (c) =>
                    `<td style='background-color:#fff3e0;color:#e65100;'>${
                      c || "&nbsp;"
                    }</td>`
                )
                .join("") +
              `</tr>`;
          });
          html += `</tbody></table>`;
          html += `<div class='d-flex justify-content-center gap-3 mb-2'>
            <span class='badge' style='background-color:#e3f2fd;color:#1565c0;'>Real Alphabet</span>
            <span class='badge' style='background-color:#fff3e0;color:#e65100;'>Shifted Alphabet</span>
          </div>`;
          return html;
        }

        document.getElementById("gameContainer").innerHTML = `
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="fw-bold" style="color:#1565c0;"><svg xmlns='http://www.w3.org/2000/svg' width='20' height='20' fill='#1565c0' class='bi bi-person-fill me-1' viewBox='0 0 16 16'><path d='M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z'/></svg> ${username}</span>
            <h2 class="card-title text-center mb-0 flex-grow-1" style="color:#0d1a4a; letter-spacing:1px; font-weight:bold; font-family:'Segoe UI','Arial',sans-serif;">Guess The Word</h2>
            <span class="fw-bold" id="timer" style="color:#1565c0;">00:00</span>
          </div>
          <div class="mb-3">
            <label class="form-label">Encrypted Word</label>
            <div class="form-control text-center mb-2" readonly style="font-weight:bold; font-size:1.2rem; color: red; text-transform: uppercase;">${encryptedWord}</div>
          </div>
          ${buildAlphabetTable(key)}
          <form id="answerForm">
            <div class="mb-3">
              <label for="answer" class="form-label">Your Answer</label>
              <input type="text" class="form-control" id="answer" name="answer" required autocomplete="off">
            </div>
            <button type="submit" class="btn btn-success w-100">Submit</button>
          </form>
          <!-- Toast for wrong answer (center top) -->
          <div class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 11">
            <div id="wrongToast" class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
              <div class="d-flex">
                <div class="toast-body">
                  Incorrect. Try again!
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
              </div>
            </div>
          </div>
        `;
        // Start timer interval
        timerInterval = setInterval(() => {
          const elapsed = Date.now() - startTime;
          document.getElementById("timer").textContent = formatTime(elapsed);
        }, 1000);
        document
          .getElementById("answerForm")
          .addEventListener("submit", submitAnswer);
      }

      // Render result screen
      function renderResult(word, trivia) {
        // Get username and school from previous form values
        let username = localStorage.getItem("lastUsername") || "";
        let school = localStorage.getItem("lastSchool") || "";
        // Fallback if not set
        if (!username && document.getElementById("username")) {
          username = document.getElementById("username").value;
        }
        if (!school && document.getElementById("school")) {
          school = document.getElementById("school").value;
        }
        const timeSec = Math.max(
          1,
          Math.round(
            (typeof startTime !== "undefined" ? Date.now() - startTime : 0) /
              1000
          )
        );
        const score = Math.round((word.length * 1000) / timeSec);
        saveLeaderboard({ username, school, word, time: timeSec, score });
        document.getElementById("gameContainer").innerHTML = `
          <h2 class="card-title mb-4 text-success text-center">Correct!</h2>
          <p class="text-center">The word was <strong>${word}</strong></p>
          <p class="text-center text-secondary" style="font-style:italic;">
            <span style="font-size:1.2em;">ðŸ’¡</span> Did you know? ${trivia}
          </p>
          <p class="text-center mb-2"><strong>Time:</strong> ${timeSec} seconds<br><strong>Score:</strong> ${score}</p>
          <div class="d-flex justify-content-center">
            <button id="homeBtn" class="btn btn-primary mt-3 px-5">Home</button>
          </div>
        `;
        // Stop timer if running
        if (typeof timerInterval !== "undefined") {
          clearInterval(timerInterval);
        }
        document
          .getElementById("homeBtn")
          .addEventListener("click", renderHome);
      }

      // Start game handler
      function startGame(e) {
        e.preventDefault();
        // Save username and school for later use
        const username = document.getElementById("username").value;
        const school = document.getElementById("school").value;
        localStorage.setItem("lastUsername", username);
        localStorage.setItem("lastSchool", school);
        renderQuestion();
      }

      // Submit answer handler
      function submitAnswer(ev) {
        ev.preventDefault();
        const userAnswer = document
          .getElementById("answer")
          .value.trim()
          .toLowerCase();
        if (userAnswer === selectedWord.toLowerCase()) {
          const triviaObj = questions.find(
            (q) => q.word.toLowerCase() === selectedWord.toLowerCase()
          );
          renderResult(selectedWord, triviaObj ? triviaObj.trivia : "");
        } else {
          const toastEl = document.getElementById("wrongToast");
          const toast = new bootstrap.Toast(toastEl);
          toast.show();
        }
      }

      // Initial render
      renderHome();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
