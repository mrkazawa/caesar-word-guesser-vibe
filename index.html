<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Caesar Word Guesser</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .game-header {
        color: #0d1a4a;
        font-family: "Segoe UI", "Arial", sans-serif;
        font-weight: bold;
        letter-spacing: 1px;
      }
      /* Rank colors for leaderboard */
      .rank-gold {
        color: #8d6a00 !important;
        font-weight: bold;
      }
      .rank-silver {
        color: #444444 !important;
        font-weight: bold;
      }
      .rank-copper {
        color: #5a2e0c !important;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div
      class="container min-vh-100 d-flex justify-content-center align-items-center"
    >
      <div class="w-100">
        <div id="gameContainer"></div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Leaderboard helpers
      function getLeaderboard() {
        return JSON.parse(localStorage.getItem("leaderboard") || "[]");
      }
      function saveLeaderboard(entry) {
        const leaderboard = getLeaderboard();
        // Add timestamp if not present
        if (!entry.timestamp) {
          entry.timestamp = new Date().toISOString();
        }
        leaderboard.push(entry);
        // Store all entries - no limit
        localStorage.setItem("leaderboard", JSON.stringify(leaderboard));
      }
      function censorPhone(phone) {
        if (!phone || phone === "N/A") return phone;
        const phoneStr = phone.toString();
        if (phoneStr.length <= 4) return phoneStr;

        // Show first 3 digits, mask middle digits, show last 2 digits
        const start = phoneStr.substring(0, 3);
        const end = phoneStr.substring(phoneStr.length - 2);
        const middle = "*".repeat(Math.max(0, phoneStr.length - 5));

        return start + middle + end;
      }
      function downloadCSV() {
        const leaderboard = getLeaderboard();
        if (leaderboard.length === 0) {
          alert("No data to export!");
          return;
        }

        // CSV headers
        const headers = [
          "#",
          "Username",
          "School",
          "Phone",
          "Time (s)",
          "Word",
          "Timestamp",
        ];

        // Convert data to CSV format
        const csvData = leaderboard.map((entry, index) => {
          return [
            index + 1,
            `"${entry.username || ""}"`,
            `"${entry.school || ""}"`,
            `"${entry.phone || ""}"`,
            entry.time || "",
            `"${entry.word || ""}"`,
            `"${entry.timestamp || ""}"`,
          ].join(",");
        });

        // Combine headers and data
        const csvContent = [headers.join(","), ...csvData].join("\n");

        // Create and download file
        const blob = new Blob([csvContent], {
          type: "text/csv;charset=utf-8;",
        });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute(
          "download",
          `caesar_players_${new Date().toISOString().split("T")[0]}.csv`
        );
        link.style.visibility = "hidden";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
      function leaderboardTableHtml() {
        const leaderboard = getLeaderboard();
        const recentPlayers = leaderboard.slice(-10).reverse(); // 10 most recent, most recent first
        let html = `
<table class="table table-sm table-bordered text-center mb-4">
  <thead class="table-primary">
    <tr>
      <th>#</th>
      <th>Username</th>
      <th>School</th>
      <th>Phone</th>
      <th>Time (s)</th>
    </tr>
  </thead>
  <tbody>
`;
        for (let i = 0; i < 10; i++) {
          const entry = recentPlayers[i];
          html += `
    <tr>
      <td>${entry ? i + 1 : "-"}</td>
      <td>${entry ? entry.username : "-"}</td>
      <td>${entry ? entry.school : "-"}</td>
      <td>${entry ? censorPhone(entry.phone || "N/A") : "-"}</td>
      <td>${entry ? entry.time : "-"}</td>
    </tr>
`;
        }
        html += `
  </tbody>
</table>
`;
        return html;
      }
      // Load caesarCipher.js
      let caesarCipher;
      let encrypt;
      let decrypt;
      // Load questions.json
      let questions = [];
      let selectedWord = "";
      let encryptedWord = "";
      let key = 0;
      // Move startTime and timerInterval to global scope
      let startTime;
      let timerInterval;

      // Fetch questions.json
      fetch("questions.json")
        .then((response) => response.json())
        .then((data) => {
          questions = data;
        });

      // Caesar cipher implementation (copied from caesarCipher.js)
      caesarCipher = function (text, key) {
        return text
          .split("")
          .map((char) => {
            if (char.match(/[a-z]/)) {
              let code = char.charCodeAt(0);
              return String.fromCharCode(((code - 97 + key + 26) % 26) + 97);
            } else if (char.match(/[A-Z]/)) {
              let code = char.charCodeAt(0);
              return String.fromCharCode(((code - 65 + key + 26) % 26) + 65);
            } else {
              return char;
            }
          })
          .join("");
      };
      encrypt = function (text, key) {
        return caesarCipher(text, key);
      };
      decrypt = function (text, key) {
        return caesarCipher(text, -key);
      };

      // Render home screen
      function renderHome() {
        document.getElementById("gameContainer").innerHTML = `
          <div class="row justify-content-center">
            <div class="col-md-5 col-12 mb-4 mb-md-0 pe-md-5 pe-4">
              <h2 class="game-header text-center mb-4">Guess The Word</h2>
              <form id="startForm">
                <div class="mb-3">
                  <label for="username" class="form-label">Username</label>
                  <input type="text" class="form-control" id="username" name="username" required />
                </div>
                <div class="mb-3">
                  <label for="school" class="form-label">School</label>
                  <input type="text" class="form-control" id="school" name="school" placeholder="Enter your school" required />
                </div>
                <div class="mb-3">
                  <label for="phone" class="form-label">Phone Number</label>
                  <input type="number" class="form-control" id="phone" name="phone" placeholder="Enter your phone number" required />
                </div>
                <button type="submit" class="btn btn-primary w-100">Play</button>
              </form>
              <div class="text-center mt-3">
                <a href="#" id="howToPlayLink" style="text-decoration:underline;cursor:pointer;">How to play?</a>
              </div>
            </div>
            <div class="col-md-7 col-12 ps-md-5 ps-4">
              <div class="d-flex align-items-center justify-content-between mb-4">
                <h2 class="game-header text-center mb-0">Recent Players</h2>
                <div class="d-flex gap-2">
                  <button id="downloadCSVBtn" class="btn btn-success">Download CSV</button>
                  <button id="clearLeaderboardBtn" class="btn btn-danger">Clear Table</button>
                </div>
              </div>
              <div id="leaderboardContainer">
                ${leaderboardTableHtml()}
              </div>
            </div>
          </div>
          <!-- Modal for password input -->
          <!-- Modal for How to Play -->
          <div class="modal fade" id="howToPlayModal" tabindex="-1" aria-labelledby="howToPlayModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="howToPlayModalLabel">How to Play: Caesar Cipher Example</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <p>The Caesar cipher shifts each letter by a fixed number. For example, with a key of <strong>3</strong>:</p>
                  <table class="table table-bordered text-center mb-3">
                    <thead>
                      <tr>
                        <th colspan="5">Original Word: <span style="color:#1565c0;font-weight:bold;">APPLE</span></th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <th style="background-color:#e3f2fd;color:#1565c0;">A</th>
                        <th style="background-color:#e3f2fd;color:#1565c0;">P</th>
                        <th style="background-color:#e3f2fd;color:#1565c0;">P</th>
                        <th style="background-color:#e3f2fd;color:#1565c0;">L</th>
                        <th style="background-color:#e3f2fd;color:#1565c0;">E</th>
                      </tr>
                      <tr>
                        <td style="background-color:#fff3e0;color:#e65100;">D</td>
                        <td style="background-color:#fff3e0;color:#e65100;">S</td>
                        <td style="background-color:#fff3e0;color:#e65100;">S</td>
                        <td style="background-color:#fff3e0;color:#e65100;">O</td>
                        <td style="background-color:#fff3e0;color:#e65100;">H</td>
                      </tr>
                    </tbody>
                  </table>
                  <ul>
                    <li><strong>Encryption:</strong> Shift each letter by 3. <span style="color:#1565c0;font-weight:bold;">APPLE</span> becomes <span style="color:#e65100;font-weight:bold;">DSSOH</span>.</li>
                    <li><strong>Decryption:</strong> Shift each letter back by 3. <span style="color:#e65100;">DSSOH</span> becomes <span style="color:#1565c0;font-weight:bold;">APPLE</span>.</li>
                  </ul>
                  <p class="mt-2">Try to guess the original word from the encrypted version!</p>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
          </div>
          <div class="modal fade" id="clearModal" tabindex="-1" aria-labelledby="clearModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="clearModalLabel">Clear Leaderboard</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="mb-3">
                    <label for="clearPassword" class="form-label">Enter password to clear:</label>
                    <input type="password" class="form-control" id="clearPassword" autocomplete="off" />
                  </div>
                  <div id="clearError" class="text-danger small" style="display:none;">Incorrect password.</div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="button" class="btn btn-primary" id="confirmClearBtn">Submit</button>
                </div>
              </div>
            </div>
          </div>
        `;
        document
          .getElementById("startForm")
          .addEventListener("submit", startGame);

        // Add phone number validation - only allow digits
        const phoneInput = document.getElementById("phone");
        if (phoneInput) {
          phoneInput.addEventListener("input", function (e) {
            // Remove any non-digit characters
            e.target.value = e.target.value.replace(/[^0-9]/g, "");
          });

          phoneInput.addEventListener("keypress", function (e) {
            // Prevent non-numeric key presses
            if (
              !/[0-9]/.test(e.key) &&
              !["Backspace", "Delete", "Tab", "Enter"].includes(e.key)
            ) {
              e.preventDefault();
            }
          });
        }

        // Add How to Play link handler
        setTimeout(function () {
          const howToPlayLink = document.getElementById("howToPlayLink");
          if (howToPlayLink) {
            howToPlayLink.onclick = function (e) {
              e.preventDefault();
              const howToPlayModal = new bootstrap.Modal(
                document.getElementById("howToPlayModal")
              );
              howToPlayModal.show();
            };
          }
        }, 0);

        // Add download CSV button handler
        const downloadBtn = document.getElementById("downloadCSVBtn");
        if (downloadBtn) {
          downloadBtn.onclick = downloadCSV;
        }

        // Add clear leaderboard button handler
        const clearBtn = document.getElementById("clearLeaderboardBtn");
        if (clearBtn) {
          clearBtn.onclick = function () {
            const clearModal = new bootstrap.Modal(
              document.getElementById("clearModal")
            );
            document.getElementById("clearPassword").value = "";
            document.getElementById("clearError").style.display = "none";
            clearModal.show();
            document.getElementById("confirmClearBtn").onclick = function () {
              const pwd = document.getElementById("clearPassword").value;
              if (pwd === "isbmantap") {
                localStorage.removeItem("leaderboard");
                document.getElementById("leaderboardContainer").innerHTML =
                  leaderboardTableHtml();
                clearModal.hide();
                // Re-attach handler after re-render
                const newClearBtn = document.getElementById(
                  "clearLeaderboardBtn"
                );
                if (newClearBtn) {
                  newClearBtn.onclick = clearBtn.onclick;
                }
              } else {
                document.getElementById("clearError").style.display = "block";
              }
            };
          };
        }
      }

      // Render question screen
      function renderQuestion() {
        // Select a random word
        if (questions.length === 0) {
          alert("Questions not loaded yet. Please try again.");
          return;
        }
        // Get username from previous form
        const username = document.getElementById("username").value;
        // Start timer
        startTime = Date.now();
        let timerInterval;
        function formatTime(ms) {
          const totalSeconds = Math.floor(ms / 1000);
          const minutes = String(Math.floor(totalSeconds / 60)).padStart(
            2,
            "0"
          );
          const seconds = String(totalSeconds % 60).padStart(2, "0");
          return `${minutes}:${seconds}`;
        }
        // Select word and encrypt
        const randomIndex = Math.floor(Math.random() * questions.length);
        selectedWord = questions[randomIndex].word;
        key = Math.floor(Math.random() * 25) + 1; // key between 1 and 25
        encryptedWord = encrypt(selectedWord, key).toUpperCase();

        function buildAlphabetTable(key) {
          const real = Array.from({ length: 26 }, (_, i) =>
            String.fromCharCode(65 + i)
          );
          const shifted = real.map((c, i) =>
            String.fromCharCode(65 + ((i + key) % 26))
          );
          const usedReal = Array.from(
            new Set(selectedWord.toUpperCase().split(""))
          );
          const usedShifted = Array.from(new Set(encryptedWord.split("")));
          let blankReal = new Set();
          let blankShifted = new Set();
          usedReal.forEach((letter) => {
            let idx = real.indexOf(letter);
            if (idx !== -1) {
              if (Math.random() < 0.5) {
                blankReal.add(letter);
              } else {
                blankShifted.add(shifted[idx]);
              }
            }
          });
          let rows = [];
          for (let i = 0; i < 26; i += 13) {
            rows.push({
              real: real
                .slice(i, i + 13)
                .map((c) => (blankReal.has(c) ? "" : c)),
              shifted: shifted
                .slice(i, i + 13)
                .map((c) => (blankShifted.has(c) ? "" : c)),
            });
          }
          let html = `<table class='table table-bordered text-center align-middle mt-3'>
            <thead>
              <tr><th colspan='13'>Alphabet Mapping (Key: ${key})</th></tr>
            </thead>
            <tbody>`;
          rows.forEach((row) => {
            html +=
              `<tr>` +
              row.real
                .map(
                  (c) =>
                    `<th style='background-color:#e3f2fd;color:#1565c0;'>${
                      c || "&nbsp;"
                    }</th>`
                )
                .join("") +
              `</tr>`;
            html +=
              `<tr>` +
              row.shifted
                .map(
                  (c) =>
                    `<td style='background-color:#fff3e0;color:#e65100;'>${
                      c || "&nbsp;"
                    }</td>`
                )
                .join("") +
              `</tr>`;
          });
          html += `</tbody></table>`;
          html += `<div class='d-flex justify-content-center gap-3 mb-2'>
            <span class='badge' style='background-color:#e3f2fd;color:#1565c0;'>Real Alphabet</span>
            <span class='badge' style='background-color:#fff3e0;color:#e65100;'>Shifted Alphabet</span>
          </div>`;
          return html;
        }

        document.getElementById("gameContainer").innerHTML = `
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="fw-bold" style="color:#1565c0;"><svg xmlns='http://www.w3.org/2000/svg' width='20' height='20' fill='#1565c0' class='bi bi-person-fill me-1' viewBox='0 0 16 16'><path d='M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z'/></svg> ${username}</span>
            <h2 class="card-title text-center mb-0 flex-grow-1" style="color:#0d1a4a; letter-spacing:1px; font-weight:bold; font-family:'Segoe UI','Arial',sans-serif;">Guess The Word</h2>
            <span class="fw-bold" id="timer" style="color:#1565c0;">00:00</span>
          </div>
          <div class="mb-3">
            <label class="form-label">Encrypted Word</label>
            <div class="form-control text-center mb-2" readonly style="font-weight:bold; font-size:1.2rem; color: #e65100; text-transform: uppercase;">${encryptedWord}</div>
          </div>
          ${buildAlphabetTable(key)}
          <form id="answerForm">
            <div class="mb-3">
              <label for="answer" class="form-label" style="color:#1565c0;">Your Answer (Find the Real Alphabet)</label>
              <input type="text" class="form-control" id="answer" name="answer" required autocomplete="off" style="color:#1565c0; font-weight:bold;">
            </div>
            <div class="d-flex gap-2">
              <button type="button" id="backBtn" class="btn btn-outline-secondary">Back</button>
              <button type="submit" class="btn btn-success flex-grow-1">Submit</button>
            </div>
          </form>
          <!-- Toast for wrong answer (center top) -->
          <div class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 11">
            <div id="wrongToast" class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
              <div class="d-flex">
                <div class="toast-body">
                  Incorrect. Try again!
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
              </div>
            </div>
          </div>
        `;
        // Start timer interval
        timerInterval = setInterval(() => {
          const elapsed = Date.now() - startTime;
          document.getElementById("timer").textContent = formatTime(elapsed);
        }, 1000);

        // Add home button handler
        document
          .getElementById("backBtn")
          .addEventListener("click", function () {
            if (typeof timerInterval !== "undefined") {
              clearInterval(timerInterval);
            }
            renderHome();
          });

        document
          .getElementById("answerForm")
          .addEventListener("submit", submitAnswer);
      }

      // Render result screen
      function renderResult(word, trivia) {
        // Get username, school, and phone from localStorage
        let username = localStorage.getItem("lastUsername") || "";
        let school = localStorage.getItem("lastSchool") || "";
        let phone = localStorage.getItem("lastPhone") || "";
        // Fallback if not set
        if (!username && document.getElementById("username")) {
          username = document.getElementById("username").value;
        }
        if (!school && document.getElementById("school")) {
          school = document.getElementById("school").value;
        }
        if (!phone && document.getElementById("phone")) {
          phone = document.getElementById("phone").value;
        }
        const timeSec = Math.max(
          1,
          Math.round(
            (typeof startTime !== "undefined" ? Date.now() - startTime : 0) /
              1000
          )
        );
        saveLeaderboard({ username, school, phone, word, time: timeSec });
        document.getElementById("gameContainer").innerHTML = `
          <h2 class="card-title mb-4 text-success text-center">Correct!</h2>
          <p class="text-center">The word was <strong>${word}</strong></p>
          <p class="text-center text-secondary" style="font-style:italic;">
            <span style="font-size:1.2em;">ðŸ’¡</span> Did you know? ${trivia}
          </p>
          <p class="text-center mb-2"><strong>Time:</strong> ${timeSec} seconds</p>
          <div class="d-flex justify-content-center">
            <button id="homeBtn" class="btn btn-primary mt-3 px-5">Home</button>
          </div>
        `;
        // Stop timer if running
        if (typeof timerInterval !== "undefined") {
          clearInterval(timerInterval);
        }
        document
          .getElementById("homeBtn")
          .addEventListener("click", renderHome);
      }

      // Start game handler
      function startGame(e) {
        e.preventDefault();
        // Save username, school, and phone for later use
        const username = document.getElementById("username").value;
        const school = document.getElementById("school").value;
        const phone = document.getElementById("phone").value;
        localStorage.setItem("lastUsername", username);
        localStorage.setItem("lastSchool", school);
        localStorage.setItem("lastPhone", phone);
        renderQuestion();
      }

      // Submit answer handler
      function submitAnswer(ev) {
        ev.preventDefault();
        const userAnswer = document
          .getElementById("answer")
          .value.trim()
          .toLowerCase();
        if (userAnswer === selectedWord.toLowerCase()) {
          const triviaObj = questions.find(
            (q) => q.word.toLowerCase() === selectedWord.toLowerCase()
          );
          renderResult(selectedWord, triviaObj ? triviaObj.trivia : "");
        } else {
          const toastEl = document.getElementById("wrongToast");
          const toast = new bootstrap.Toast(toastEl);
          toast.show();
        }
      }

      // Initial render
      renderHome();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
